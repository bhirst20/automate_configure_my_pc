#!/bin/bash

# gitquick - Quick AI-generated commits for debugging/testing
# Usage: gitquick [mode] [--claude]
#   Modes: debug (default), fix, syntax
#   --claude: Use Claude instead of Fabric/Ollama

# Set theme based on mode
case $MODE in
    debug)  THEME="debugging and testing changes" ;;
    fix)    THEME="minor bug fixes" ;;
    syntax) THEME="syntax and formatting fixes" ;;
    *)      THEME="general changes" ;;
esac

# Get changes since last push (or all staged/unstaged if no remote tracking)
DIFF=$(git diff HEAD 2>/dev/null)

# Build the prompt
PROMPT="Generate a concise git commit message (max 72 chars for first line) for these changes.
Theme: $THEME
Keep it brief and technical. No quotes around the message. Just output the commit message, nothing else.

Changes:
$DIFF"

# Generate commit message
echo "Generating commit message with Fabric..."
COMMIT_MSG=$(echo "$PROMPT" | fabric --model mistral:latest --pattern summarize_pull-requests)

# Fallback if AI fails
if [ -z "$COMMIT_MSG" ]; then
    echo "AI generation failed, using default message"
    COMMIT_MSG="$MODE: quick changes"
fi

# Clean up the message (remove quotes, trim whitespace)
COMMIT_MSG=$(echo "$COMMIT_MSG" | sed 's/^["'"'"']//;s/["'"'"']$//')

echo ""
echo "Commit message: $COMMIT_MSG"
echo ""
read -p "Proceed with commit and push? [Y/n]: " confirm
confirm=${confirm:-Y}

if [[ "$confirm" =~ ^[Yy]$ ]]; then
    git add .
    git commit -m "$COMMIT_MSG"
    git push
    echo "Done!"
else
    echo "Aborted"
fi
