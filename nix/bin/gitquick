#!/bin/bash

# gitquick - Quick AI-generated commits for debugging/testing
# Usage: gitquick [mode] [--claude]
#   Modes: debug (default), fix, syntax
#   --claude: Use Claude instead of Fabric/Ollama

MODE="${1:-debug}"
USE_CLAUDE=false

# Parse args
for arg in "$@"; do
    case $arg in
        --claude) USE_CLAUDE=true ;;
        debug|fix|syntax) MODE="$arg" ;;
    esac
done

# Set theme based on mode
case $MODE in
    debug)  THEME="debugging and testing changes" ;;
    fix)    THEME="minor bug fixes" ;;
    syntax) THEME="syntax and formatting fixes" ;;
    *)      THEME="general changes" ;;
esac

# Get changes since last push (or all staged/unstaged if no remote tracking)
if git rev-parse @{u} >/dev/null 2>&1; then
    DIFF=$(git diff @{u}..HEAD 2>/dev/null)
    # If no commits ahead, get working directory changes
    if [ -z "$DIFF" ]; then
        DIFF=$(git diff HEAD 2>/dev/null)
    fi
else
    DIFF=$(git diff HEAD 2>/dev/null)
fi

# Fallback to staged + unstaged
if [ -z "$DIFF" ]; then
    DIFF=$(git diff 2>/dev/null)
fi

if [ -z "$DIFF" ]; then
    echo "No changes detected"
    exit 1
fi

# Build the prompt
PROMPT="Generate a concise git commit message (max 72 chars for first line) for these changes.
Theme: $THEME
Keep it brief and technical. No quotes around the message. Just output the commit message, nothing else.

Changes:
$DIFF"

# Generate commit message
if [ "$USE_CLAUDE" = true ]; then
    echo "Generating commit message with Claude..."
    COMMIT_MSG=$(echo "$PROMPT" | claude --print 2>/dev/null)
else
    echo "Generating commit message with Fabric..."
    COMMIT_MSG=$(echo "$PROMPT" | fabric --model llama3.2 2>/dev/null)
fi

# Fallback if AI fails
if [ -z "$COMMIT_MSG" ] || [ $? -ne 0 ]; then
    echo "AI generation failed, using default message"
    COMMIT_MSG="$MODE: quick changes"
fi

# Clean up the message (remove quotes, trim whitespace)
COMMIT_MSG=$(echo "$COMMIT_MSG" | sed 's/^["'"'"']//;s/["'"'"']$//' | head -1 | xargs)

echo ""
echo "Commit message: $COMMIT_MSG"
echo ""
read -p "Proceed with commit and push? [Y/n]: " confirm
confirm=${confirm:-Y}

if [[ "$confirm" =~ ^[Yy]$ ]]; then
    git add .
    git commit -m "$COMMIT_MSG"
    git push
    echo "Done!"
else
    echo "Aborted"
fi
